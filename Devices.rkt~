#lang racket
(#%require "Utillities.rkt")
(#%provide make-tempsensor)


(define (make-tempsensor name serialnumber)
  (let-values ([(input output) (make-pipe)]  ;aanmaken van outputfile bij het aanmaken van het object
               [(written-counter) #f] 
               [(current-temp) 25] ) ;je mag er vanuit gaan dat je eerst een outputport hebt aangezien je eerst wil schrijven 
    
    
    (define (get-name-sim)
      name)
    
    
    (define (get-temp) 
      `(ACK (TEMP ,current-temp)))
    
    (define (get-name)
      `(ACK (NAME  ,name)))
    
    (define (get-serial) 
      `(ACK (SERIAL ,serialnumber)))
    
    
    (define (generate-answer)
      (let*((commando (read input))
            (prefix (car commando))  ;controle of commando geldig is
            (asked (cadr commando)))
        ;wat er gevraagd is
        (if (eq? 'get prefix)
            (case asked
              ((name) (get-name))
              ((temp) (get-temp))
              ((serial) (get-serial))
              (else `(NACK , commando)))
            `(NACK , commando))))
   
    (define (change-wc!) (if written-counter 
                             (set! written-counter #f)
                             (set! written-counter #t)))
    
    ;bij elke oproep van my-device-port wordt de variable port verandert in een iput/ouputport

    (define (get-device-output-port)
     output)
    

    
    (define (get-device-input-port)
      (make-input-port
       'name 
      (lambda (ignore)
      (let-values (((in out) (make-pipe))
                   ((answer) 'none))
      (set! answer (generate-answer))
        (write answer out)
        in))
      #f
      (lambda () 'closed)))
  
    
    
    (define (dispatch message)
      (case message
        ((get-name-sim) (get-name-sim))
        ((get-device-output-port) get-device-output-port)
        ((get-device-input-port) get-device-input-port)
        (else (error 'tempsensor "unknown message ~a" message))))
    
    
    dispatch))



