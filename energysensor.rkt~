#lang R5RS

#lang R5RS

(#%require "Utillities.rkt")
(#%provide (all-defined))

(define (make-energyplug)
  (let ((64-adress  #(0 19 162 0 64 148 36 184)
        (16-adress #(0 0))
        (BRI "321x")
        (DBRI "1231x")
        (TEM "27,5Â°C")
        (DTEM "1988mA")
        (HUM "65%")
        (DHUM "5%")
        (name "MultiSensor")
        (PRES "1015.46hPa")
        (DPRES "12hPa")
        (BAT "OK")
        (UBAT "3.85V")
        (HITEM "22.0")
        (LOTEM "18.0")
        (TXT "1800")
        (MSI "120"))
        
        (define (get_name) 
          name)
        
        (define (get_64-adress)
          64-adress)
        
        (define (get_16-adress)
          16-adress)
        
        (define(get-command message)
          (vector->string (vector-loop 1 3 message)))
        
          
  (define (append_string . arguments)
    (define (loop lst result)
      (if (null? lst)
          (list->string result)
          (loop (cdr lst) (append result (string->list (car lst))))))
    (loop arguments '()))
        
        ;voorbereiden van antwoord van getframe
        ;geeft string terug
        (define (prepare_getframe)
          (append_string "BRI=" BRI "\n"
                  "DBRI=" DBRI "\n"
                  "TEM=" TEM "\n"
                  "DTEM=" DTEM  "\n"
                  "HUM=" HUM "\n"
                  "DHUM=" DHUM  "\n"
                  "PRES=" PRES  "\n"
                  "DPRES=" DPRES  "\n"
                  "BAT=" BAT "\n"
          "DHUM=" UBAT  "\n"))
        
        
        (define (execute_set message)
          (let ((3_letter_command (vector->string (vector-loop 5 7 message))) ;SET + spatie is voorafgaand is vector
                (5_letter_command (vector->string (vector-loop 5 9 message)))
                (nack #f))
            (display 3_letter_command)
           (newline)
            (cond ((equal? 3_letter_command "TXT")
                   (let ((new_val (vector-loop 9 (vector-length message) message)))
                     (display (vector->string new_val))
                     (set! TXT (vector->list new_val))))
                   ((equal? 3_letter_command "MSI")
                    (let ((new_val (vector-loop 9 (vector-length message) message)))
                      (display (vector->string new_val))
                      (set! MSI new_val)))
                   ((equal? 5_letter_command "LOTEM")
                    (let ((new_val (vector-loop 11 (vector-length message) message)))
                      (display (vector->string new_val))
                      (set! LOTEM new_val)))
                   ((equal? 5_letter_command "HITEM")
                    (let ((new_val (vector-loop 11 (vector-length message) message))) 
                      (display (vector->string new_val))
                      (set! HITEM new_val)))
                   ((equal? 5_letter_command "LOBRI")
                    (let ((new_val (vector-loop 11 (vector-length message) message))) 
                      (display (vector->string new_val))
                      (set! LOBRI new_val)))
                   ((equal? 5_letter_command "HIBRI")
                    (let ((new_val ((vector-loop 11 (vector-length message) message))) )
                      (display (vector->string new_val))
                      (set! HIBRI new_val)))
                   (else (set! #t)))
            (if (not nack)
            (list->string (list "ack " message))
            (list->string (list "nack " message))
            )))
        
        
        (define (handle-request message)
          (let ((command (get-command message)))
            (cond ((equal? command "GET")
                   (prepare_getframe))
            ((equal? command "SET")
             (execute_set message))
            (else (display "command not recognized")))))
        
        
        (define (dispatch message)
          (case message
            ((get_64_adress) get_64-adress)
            ((get_name) get_name)
            ((get_16-adress) get_16-adress)
            ((request) handle-request)
            (else (display "unknown message ~a" message))))
        
        dispatch)
    )
  
  (define (string->vector string)
    (list->vector (map char->integer (string->list string))))
  
  (define (vector->string vector)
    (list->string  (map integer->char (vector->list vector))))
  
  
  ;hulpfunctie om snel info uit verctors te krijge
  (define (vector-loop start end given-vector)
    (define (loop counter final-vector)
      (if (> counter end)
          final-vector
          (begin
            (vector-set! final-vector (- counter start) (vector-ref given-vector (- counter 1)))
            (loop (+ counter 1) final-vector))))
    (loop start (make-vector (+ (- end start) 1))))
  
  
  (define Transmit_status 139)
  (define Transmit_answer 144)
  
  
  (define p (make-powerplug))
  (send p 'request #(83 69 84 32 80 79 87 61 79 78 10))
  

  
